<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Safety Alert</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 30px;
            padding: 40px 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header .icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 2rem;
            color: #dc2626;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1rem;
            line-height: 1.6;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .emergency-options {
            display: grid;
            gap: 15px;
            margin-bottom: 30px;
        }

        .emergency-button {
            background: white;
            border: 3px solid #e5e7eb;
            border-radius: 20px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .emergency-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .emergency-button.selected {
            border-color: #dc2626;
            background: #fef2f2;
        }

        .emergency-button .icon {
            font-size: 3rem;
            flex-shrink: 0;
        }

        .emergency-button .content {
            flex: 1;
            text-align: left;
        }

        .emergency-button .title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .emergency-button .description {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 20px;
        }

        textarea:focus {
            outline: none;
            border-color: #dc2626;
        }

        .action-button {
            width: 100%;
            background: #dc2626;
            color: white;
            border: none;
            padding: 20px;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .action-button:hover:not(:disabled) {
            background: #b91c1c;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(220, 38, 38, 0.4);
        }

        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-button.sending {
            animation: pulse 1.5s ease infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.85; }
        }

        .back-button {
            background: rgba(220, 38, 38, 0.1);
            color: #dc2626;
        }

        .back-button:hover {
            background: rgba(220, 38, 38, 0.2);
        }

        .info-box {
            background: #fef2f2;
            border: 2px solid #fecaca;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .info-box h3 {
            color: #dc2626;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .info-box p {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.6;
            margin: 0;
        }

        .info-box ul {
            margin-top: 10px;
            padding-left: 20px;
        }

        .info-box li {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.6;
            margin: 5px 0;
        }

        .alert-sent {
            text-align: center;
            padding: 40px 0;
        }

        .alert-icon {
            font-size: 5rem;
            color: #10b981;
            margin-bottom: 20px;
            animation: checkPulse 1s ease infinite;
        }

        @keyframes checkPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }

        .alert-title {
            font-size: 2rem;
            color: #333;
            margin-bottom: 15px;
        }

        .alert-message {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .response-time {
            background: #f0fdf4;
            border: 2px solid #86efac;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .response-time h3 {
            color: #10b981;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .response-time p {
            color: #666;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Select Emergency Type -->
        <div id="select-step" class="step-content active">
            <div class="header">
                <div class="icon">üö®</div>
                <h1>Emergency Alert</h1>
                <p>Select the type of emergency to immediately notify venue security and staff</p>
            </div>

            <div class="emergency-options">
                <div class="emergency-button" onclick="selectEmergency('medical')">
                    <div class="icon">ü´Ä</div>
                    <div class="content">
                        <div class="title">Medical Emergency</div>
                        <div class="description">Heart attack, injury, allergic reaction, unconsciousness</div>
                    </div>
                </div>

                <div class="emergency-button" onclick="selectEmergency('security')">
                    <div class="icon">üõ°Ô∏è</div>
                    <div class="content">
                        <div class="title">Security Threat</div>
                        <div class="description">Suspicious activity, aggressive behavior, theft</div>
                    </div>
                </div>

                <div class="emergency-button" onclick="selectEmergency('lost-person')">
                    <div class="icon">üë•</div>
                    <div class="content">
                        <div class="title">Lost Child/Person</div>
                        <div class="description">Missing child or vulnerable person</div>
                    </div>
                </div>

                <div class="emergency-button" onclick="selectEmergency('other')">
                    <div class="icon">‚ö†Ô∏è</div>
                    <div class="content">
                        <div class="title">Other Emergency</div>
                        <div class="description">Fire, structural issue, or other urgent situation</div>
                    </div>
                </div>
            </div>

            <div class="info-box">
                <h3>‚ö° Instant Response</h3>
                <p>Your alert goes directly to venue security and nearest staff members for immediate assistance.</p>
            </div>
        </div>

        <!-- Confirm and Send -->
        <div id="confirm-step" class="step-content">
            <div class="header">
                <div class="icon">üö®</div>
                <h1 id="emergency-title">Emergency Alert</h1>
                <p>Provide additional details to help responders</p>
            </div>

            <div class="info-box" id="emergency-info">
                <h3>Alert Details</h3>
                <p id="emergency-description"></p>
            </div>

            <textarea id="additional-info" placeholder="Additional details (optional)...
Examples:
‚Ä¢ Person's appearance or condition
‚Ä¢ Exact location or landmarks
‚Ä¢ Number of people involved"></textarea>

            <div class="info-box">
                <h3>üìç Your Location</h3>
                <p id="location-info">Detecting location...</p>
            </div>

            <button class="action-button" id="send-alert" onclick="sendAlert()">
                <span>üö®</span>
                <span>SEND EMERGENCY ALERT</span>
            </button>

            <button class="action-button back-button" onclick="goToStep('select')">
                ‚Üê Back to Emergency Types
            </button>
        </div>

        <!-- Alert Sent -->
        <div id="sent-step" class="step-content">
            <div class="alert-sent">
                <div class="alert-icon">‚úì</div>
                <h2 class="alert-title">Alert Sent!</h2>
                <p class="alert-message">
                    <strong>Help is on the way</strong><br>
                    Security and staff have been notified
                </p>
            </div>

            <div class="response-time">
                <h3>‚ö° Expected Response</h3>
                <p>Security dispatched to your location<br>
                <strong>ETA: 45-60 seconds</strong></p>
            </div>

            <div class="info-box">
                <h3>üìû Emergency Contacts</h3>
                <ul>
                    <li>Venue Security: [Auto-notified]</li>
                    <li>Medical: 999 (UK) / 911 (US)</li>
                    <li>Police: 999 (UK) / 911 (US)</li>
                    <li>Fire: 999 (UK) / 911 (US)</li>
                </ul>
            </div>

            <button class="action-button back-button" onclick="closeAlert()">
                ‚Üê Back to Experience
            </button>
        </div>
    </div>

    <script>
        let selectedEmergency = null;
        let locationData = null;

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const restaurantId = urlParams.get('restaurant') || 'demo-restaurant';
        const tableNumber = urlParams.get('table') || null;
        const boxNumber = urlParams.get('box') || null;

        const emergencyTypes = {
            'medical': {
                title: 'Medical Emergency',
                description: 'Heart attack, injury, allergic reaction, or unconsciousness',
                icon: 'ü´Ä',
                priority: 'CRITICAL'
            },
            'security': {
                title: 'Security Threat',
                description: 'Suspicious activity, aggressive behavior, or theft',
                icon: 'üõ°Ô∏è',
                priority: 'HIGH'
            },
            'lost-person': {
                title: 'Lost Child/Person',
                description: 'Missing child or vulnerable person',
                icon: 'üë•',
                priority: 'HIGH'
            },
            'other': {
                title: 'Other Emergency',
                description: 'Fire, structural issue, or other urgent situation',
                icon: '‚ö†Ô∏è',
                priority: 'HIGH'
            }
        };

        // Get user location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    locationData = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                },
                (error) => {
                    console.log('Location not available:', error);
                }
            );
        }

        function goToStep(stepName) {
            document.querySelectorAll('.step-content').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(stepName + '-step').classList.add('active');
        }

        function selectEmergency(type) {
            selectedEmergency = type;
            const emergency = emergencyTypes[type];
            
            // Update confirm step with emergency details
            document.getElementById('emergency-title').textContent = emergency.title;
            document.getElementById('emergency-description').textContent = emergency.description;
            
            // Update location display
            const locationInfo = document.getElementById('location-info');
            if (tableNumber) {
                locationInfo.textContent = `Table ${tableNumber}`;
            } else if (boxNumber) {
                locationInfo.textContent = `Box ${boxNumber}`;
            } else if (locationData) {
                locationInfo.textContent = `GPS: ${locationData.lat.toFixed(6)}, ${locationData.lng.toFixed(6)}`;
            } else {
                locationInfo.textContent = 'Location detected from device';
            }
            
            goToStep('confirm');
            
            trackInteraction('emergency_selected', { type: type });
        }

        async function sendAlert() {
            const sendButton = document.getElementById('send-alert');
            sendButton.disabled = true;
            sendButton.classList.add('sending');
            sendButton.innerHTML = '<span>üì°</span><span>SENDING ALERT...</span>';
            
            const additionalInfo = document.getElementById('additional-info').value;
            const emergency = emergencyTypes[selectedEmergency];
            
            try {
                await fetch('/api/emergency/alert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        restaurant_id: restaurantId,
                        table_number: tableNumber,
                        box_number: boxNumber,
                        emergency_type: selectedEmergency,
                        priority: emergency.priority,
                        additional_info: additionalInfo,
                        location: locationData,
                        timestamp: new Date().toISOString()
                    })
                });
                
                trackInteraction('emergency_alert_sent', {
                    type: selectedEmergency,
                    has_additional_info: !!additionalInfo
                });
                
                // Show success
                setTimeout(() => {
                    goToStep('sent');
                }, 1000);
                
            } catch (error) {
                console.error('Error sending alert:', error);
                alert('Error sending alert. Please call venue security directly.');
                sendButton.disabled = false;
                sendButton.classList.remove('sending');
                sendButton.innerHTML = '<span>üö®</span><span>SEND EMERGENCY ALERT</span>';
            }
        }

        function closeAlert() {
            window.history.back();
        }

        async function trackInteraction(type, data) {
            try {
                await fetch('/api/analytics/interaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        restaurant_id: restaurantId,
                        table_number: tableNumber,
                        interaction_type: type,
                        data: data,
                        timestamp: new Date().toISOString()
                    })
                });
            } catch (error) {
                console.error('Error tracking:', error);
            }
        }

        // Track page view
        trackInteraction('emergency_page_opened', {});
    </script>
</body>
</html>